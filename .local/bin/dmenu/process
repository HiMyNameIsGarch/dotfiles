#!/bin/sh

options="shutdown
reboot
lock screen"

choice=$(printf "%s" "$options" | dmenu -i -p "Choose:")
[ -z "$choice" ] && exit 1
[ "$(printf "Yes\nNo" | dmenu -i -p "Are you sure?")" = "Yes" ] || exit 1

notify() { notify-send "Doom Guy says" "$1" ; }
notifyExit() { notify-send --urgency=critical "$1" "$2" && exit 1 ; }

checkDisks() {
    baseFile="$HOME/.local/share/base-disks"
    tempFile="/tmp/disksTemp"
    lsblk > $tempFile
    disks=$(diff "$baseFile" "$tempFile" | grep part)
    mountedDisks=$(echo "$disks" | grep "/")
    [ ! -n "$mountedDisks" ]
}
SLEEPNUM=5
logSysShutdown() {
    DATE="$(date -u '+%A-%B-%Y')"
    OPEN="$(uptime -s)"
    TOTAL="$(uptime -p)"
    FILE="/home/himynameisgarch/logs/sys/uptime"
    echo "${1^} at: $(date -u '+%T')" >> "$FILE" 
    echo "On $DATE you opened you pc at ${OPEN#* }" >> "$FILE"
    echo "Total time spent: ${TOTAL#* }" >> "$FILE"
    echo "---------------------" >> "$FILE"
}
shutDown() {
    logSysShutdown "shutdown"
    notify "Shutdown now sir" &
    sleep $SLEEPNUM
    shutdown now
}
rebootSys(){
    logSysShutdown "reboot"
    notify "Reboot now sir" &
    sleep $SLEEPNUM
    shutdown -r now
}

option() { printf "%s" "$options" | sed "$1q;d" ; }
case $choice in 
    "$(option 1)") 
        checkDisks || 
            notifyExit "Mounted Disks detected!" "You can't shutdown because you have mounted disks!"
        shutDown
        ;;
    "$(option 2)") 
        checkDisks || 
            notifyExit "Mounted Disks detected!" "You can't reboot because you have mounted disks!"
        rebootSys
        ;;
    "$(option 3)") notify "Your screen will be locked" ; i3lock-fancy ;;
    *) exit 1 ;; 
esac

